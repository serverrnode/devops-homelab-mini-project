<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weather Homelab</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 40px;
      animation: fadeInDown 0.6s ease-out;
    }

    .header h1 {
      font-size: 3rem;
      font-weight: 700;
      margin-bottom: 10px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.95;
      font-weight: 400;
    }

    .search-card {
      background: white;
      border-radius: 20px;
      padding: 35px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      margin-bottom: 30px;
      animation: fadeInUp 0.6s ease-out;
    }

    .search-container {
      display: flex;
      gap: 12px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .search-input {
      flex: 1;
      min-width: 250px;
      padding: 16px 20px;
      border: 2px solid #e0e7ff;
      border-radius: 12px;
      font-size: 1rem;
      font-family: inherit;
      transition: all 0.3s ease;
      background: #f8fafc;
    }

    .search-input:focus {
      outline: none;
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .search-input::placeholder {
      color: #94a3b8;
    }

    .btn {
      padding: 16px 32px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      color: #475569;
      margin-bottom: 8px;
    }

    .select-box {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid #e0e7ff;
      border-radius: 12px;
      font-size: 1rem;
      font-family: inherit;
      background: #f8fafc;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .select-box:focus {
      outline: none;
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .select-box:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .weather-card {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: fadeInUp 0.6s ease-out;
    }

    .weather-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #f1f5f9;
      flex-wrap: wrap;
      gap: 15px;
    }

    .location-name {
      font-size: 2rem;
      font-weight: 700;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .current-weather {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 30px;
      border-radius: 16px;
      margin-bottom: 30px;
      color: white;
    }

    .current-temp {
      font-size: 4rem;
      font-weight: 700;
      margin-bottom: 15px;
    }

    .weather-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
    }

    .weather-detail {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.1rem;
    }

    .detail-icon {
      font-size: 1.5rem;
      opacity: 0.9;
    }

    .charts-section {
      margin-top: 30px;
    }

    .chart-container {
      background: #f8fafc;
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 25px;
      border: 2px solid #e0e7ff;
    }

    .chart-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chart-wrapper {
      position: relative;
      height: 300px;
    }

    .forecast-section {
      margin-top: 30px;
    }

    .forecast-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 20px;
    }

    .forecast-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }

    .forecast-day {
      background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .forecast-day:hover {
      transform: translateY(-5px);
      border-color: #667eea;
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
    }

    .forecast-date {
      font-weight: 600;
      color: #475569;
      margin-bottom: 10px;
      font-size: 0.9rem;
    }

    .forecast-temp {
      font-size: 1.3rem;
      font-weight: 700;
      color: #667eea;
      margin: 8px 0;
    }

    .forecast-rain {
      font-size: 0.85rem;
      color: #64748b;
      margin-top: 8px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #64748b;
      font-size: 1.1rem;
    }

    .error {
      background: #fee2e2;
      border: 2px solid #fca5a5;
      border-radius: 12px;
      padding: 20px;
      color: #991b1b;
      text-align: center;
      font-weight: 500;
    }

    .no-results {
      text-align: center;
      padding: 30px;
      color: #64748b;
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 2rem;
      }

      .search-card, .weather-card {
        padding: 25px;
      }

      .location-name {
        font-size: 1.5rem;
      }

      .current-temp {
        font-size: 3rem;
      }

      .forecast-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }

      .chart-wrapper {
        height: 250px;
      }
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üå§Ô∏è Weather Homelab</h1>
      <p>Search for any city worldwide and get real-time weather forecasts with visual analytics</p>
    </div>

    <div class="search-card">
      <div class="search-container">
        <input 
          id="searchInput" 
          class="search-input" 
          type="text" 
          placeholder="Search for a city... (e.g., London, Tokyo, New York)"
          autocomplete="off"
        />
        <button id="searchBtn" class="btn btn-primary">Search</button>
      </div>

      <div class="form-group" id="locationSelectGroup" style="display: none;">
        <label class="form-label">üìç Select a location:</label>
        <select id="locationSelect" class="select-box">
          <option value="">Choose a location...</option>
        </select>
      </div>

      <div style="margin-top: 20px;">
        <button id="getWeatherBtn" class="btn btn-primary" disabled>Get Weather</button>
      </div>
    </div>

    <div id="weatherCard" class="weather-card hidden"></div>
  </div>

  <script>
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const locationSelectGroup = document.getElementById('locationSelectGroup');
    const locationSelect = document.getElementById('locationSelect');
    const getWeatherBtn = document.getElementById('getWeatherBtn');
    const weatherCard = document.getElementById('weatherCard');

    let locations = [];
    let temperatureChart = null;
    let precipitationChart = null;

    function formatLocationLabel(location) {
      const parts = [location.name, location.admin1, location.country].filter(Boolean);
      return parts.join(', ');
    }

    async function searchLocations() {
      const query = searchInput.value.trim();
      if (!query) return;

      try {
        searchBtn.textContent = 'Searching...';
        searchBtn.disabled = true;

        const response = await fetch(`/api/geo?q=${encodeURIComponent(query)}`);
        const data = await response.json();

        locations = data.results || [];

        locationSelect.innerHTML = '<option value="">Choose a location...</option>';

        if (locations.length === 0) {
          weatherCard.innerHTML = `
            <div class="no-results">
              <p>No locations found for "<strong>${query}</strong>"</p>
              <p style="margin-top: 10px; color: #94a3b8;">Try searching for a different city or country</p>
            </div>
          `;
          weatherCard.classList.remove('hidden');
          locationSelectGroup.style.display = 'none';
          getWeatherBtn.disabled = true;
          return;
        }

        locations.forEach((location, index) => {
          const option = document.createElement('option');
          option.value = index;
          option.textContent = formatLocationLabel(location);
          locationSelect.appendChild(option);
        });

        locationSelectGroup.style.display = 'block';
        getWeatherBtn.disabled = false;
        weatherCard.classList.add('hidden');

      } catch (error) {
        weatherCard.innerHTML = `
          <div class="error">
            <strong>Error:</strong> Failed to search locations. Please try again.
          </div>
        `;
        weatherCard.classList.remove('hidden');
      } finally {
        searchBtn.textContent = 'Search';
        searchBtn.disabled = false;
      }
    }

    async function getWeather() {
      const selectedIndex = locationSelect.value;
      if (selectedIndex === '') return;

      const location = locations[selectedIndex];

      try {
        getWeatherBtn.textContent = 'Loading...';
        getWeatherBtn.disabled = true;

        weatherCard.innerHTML = '<div class="loading">Loading weather data...</div>';
        weatherCard.classList.remove('hidden');

        const response = await fetch(
          `/api/weather?lat=${location.latitude}&lon=${location.longitude}`
        );
        const data = await response.json();

        displayWeather(location, data);

      } catch (error) {
        weatherCard.innerHTML = `
          <div class="error">
            <strong>Error:</strong> Failed to fetch weather data. Please try again.
          </div>
        `;
      } finally {
        getWeatherBtn.textContent = 'Get Weather';
        getWeatherBtn.disabled = false;
      }
    }

    function displayWeather(location, data) {
      const { current, daily } = data;

      const forecastHTML = daily.time.map((date, index) => `
        <div class="forecast-day">
          <div class="forecast-date">${formatDate(date)}</div>
          <div class="forecast-temp">
            ${Math.round(daily.temperature_2m_max[index])}¬∞ / ${Math.round(daily.temperature_2m_min[index])}¬∞
          </div>
          <div class="forecast-rain">
            üíß ${daily.precipitation_sum[index]} mm
          </div>
        </div>
      `).join('');

      weatherCard.innerHTML = `
        <div class="weather-header">
          <div class="location-name">
            üìç ${formatLocationLabel(location)}
          </div>
        </div>

        <div class="current-weather">
          <div class="current-temp">${Math.round(current.temperature_2m)}¬∞C</div>
          <div class="weather-details">
            <div class="weather-detail">
              <span class="detail-icon">üíß</span>
              <span>${current.relative_humidity_2m}% Humidity</span>
            </div>
            <div class="weather-detail">
              <span class="detail-icon">üí®</span>
              <span>${Math.round(current.wind_speed_10m)} km/h Wind</span>
            </div>
          </div>
        </div>

        <div class="charts-section">
          <div class="chart-container">
            <div class="chart-title">üå°Ô∏è Temperature Forecast</div>
            <div class="chart-wrapper">
              <canvas id="temperatureChart"></canvas>
            </div>
          </div>

          <div class="chart-container">
            <div class="chart-title">üíß Precipitation Forecast</div>
            <div class="chart-wrapper">
              <canvas id="precipitationChart"></canvas>
            </div>
          </div>
        </div>

        <div class="forecast-section">
          <div class="forecast-title">üìÖ 7-Day Summary</div>
          <div class="forecast-grid">
            ${forecastHTML}
          </div>
        </div>
      `;

      weatherCard.classList.remove('hidden');

      // Create charts after DOM is updated
      setTimeout(() => {
        createTemperatureChart(daily);
        createPrecipitationChart(daily);
      }, 100);
    }

    function createTemperatureChart(daily) {
      const ctx = document.getElementById('temperatureChart');
      if (!ctx) return;

      // Destroy existing chart if it exists
      if (temperatureChart) {
        temperatureChart.destroy();
      }

      const labels = daily.time.map(date => formatDate(date));

      temperatureChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Max Temperature',
              data: daily.temperature_2m_max,
              borderColor: '#ef4444',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              borderWidth: 3,
              tension: 0.4,
              fill: true,
              pointRadius: 5,
              pointHoverRadius: 7,
              pointBackgroundColor: '#ef4444',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
            },
            {
              label: 'Min Temperature',
              data: daily.temperature_2m_min,
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              borderWidth: 3,
              tension: 0.4,
              fill: true,
              pointRadius: 5,
              pointHoverRadius: 7,
              pointBackgroundColor: '#3b82f6',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                usePointStyle: true,
                padding: 15,
                font: {
                  size: 12,
                  weight: '600'
                }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: {
                size: 14,
                weight: 'bold'
              },
              bodyFont: {
                size: 13
              },
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': ' + Math.round(context.parsed.y) + '¬∞C';
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)',
              },
              ticks: {
                callback: function(value) {
                  return value + '¬∞C';
                },
                font: {
                  size: 11
                }
              }
            },
            x: {
              grid: {
                display: false,
              },
              ticks: {
                font: {
                  size: 11
                }
              }
            }
          }
        }
      });
    }

    function createPrecipitationChart(daily) {
      const ctx = document.getElementById('precipitationChart');
      if (!ctx) return;

      // Destroy existing chart if it exists
      if (precipitationChart) {
        precipitationChart.destroy();
      }

      const labels = daily.time.map(date => formatDate(date));

      precipitationChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Precipitation',
            data: daily.precipitation_sum,
            backgroundColor: 'rgba(59, 130, 246, 0.6)',
            borderColor: '#3b82f6',
            borderWidth: 2,
            borderRadius: 8,
            hoverBackgroundColor: 'rgba(59, 130, 246, 0.8)',
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                usePointStyle: true,
                padding: 15,
                font: {
                  size: 12,
                  weight: '600'
                }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: {
                size: 14,
                weight: 'bold'
              },
              bodyFont: {
                size: 13
              },
              callbacks: {
                label: function(context) {
                  return 'Precipitation: ' + context.parsed.y + ' mm';
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)',
              },
              ticks: {
                callback: function(value) {
                  return value + ' mm';
                },
                font: {
                  size: 11
                }
              }
            },
            x: {
              grid: {
                display: false,
              },
              ticks: {
                font: {
                  size: 11
                }
              }
            }
          }
        }
      });
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      const today = new Date();
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);

      if (date.toDateString() === today.toDateString()) {
        return 'Today';
      } else if (date.toDateString() === tomorrow.toDateString()) {
        return 'Tomorrow';
      } else {
        return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
      }
    }

    searchBtn.addEventListener('click', searchLocations);
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') searchLocations();
    });
    getWeatherBtn.addEventListener('click', getWeather);
    locationSelect.addEventListener('change', () => {
      getWeatherBtn.disabled = locationSelect.value === '';
    });
  </script>
</body>
</html>